MongoDB ржУ Mongoose-ржП **Query Middleware** ржПржмржВ **Document Middleware**тАФржПржЗ ржжрзБржЗржЯрж╛ ржПржХрзЗржмрж╛рж░рзЗ ржнрж┐ржирзНржи ржЬрж┐ржирж┐рж╕, ржпржжрж┐ржУ ржжрзБржЯрзЛржЗ middleware рж╣рж┐рж╕рзЗржмрзЗржЗ ржХрж╛ржЬ ржХрж░рзЗред

---

## тЬЕ рж╕ржВржХрзНрж╖рж┐ржкрзНржд ржкрж╛рж░рзНржержХрзНржп:

| ржжрж┐ржХ                | Query Middleware                                                      | Document Middleware                                                  |
| ------------------ | --------------------------------------------------------------------- | -------------------------------------------------------------------- |
| **ржХржЦржи ржЪрж▓рзЗ?**       | ржпржЦржи `.find()`, `.findOne()`, `.update()` ржПрж░ ржорждрзЛ **query ржЕржкрж╛рж░рзЗрж╢ржи ржЪрж▓рзЗ** | ржпржЦржи `.save()`, `.create()`, `.remove()` ржмрж╛ `.deleteOne()` рж╣рзЯ         |
| **ржХрзА modify ржХрж░рзЗ?** | Query modify ржХрж░рзЗ тЖТ ржХрж┐ ржбрзЗржЯрж╛ fetch рж╣ржмрзЗ                                  | Document modify ржХрж░рзЗ тЖТ ржХрж┐ ржбрзЗржЯрж╛ ржбрж╛ржЯрж╛ржмрзЗржЬрзЗ ржпрж╛ржмрзЗ ржмрж╛ ржбрж╛ржЯрж╛ржмрзЗржЬ ржерзЗржХрзЗ ржЖрж╕ржмрзЗ     |
| **ржЙржжрзНржжрзЗрж╢рзНржп**       | ржбрзЗржЯрж╛ fetch ржХрж░рж╛рж░ ржЖржЧрзЗ/ржкрж░рзЗ extra filter, populate ржЗрждрзНржпрж╛ржжрж┐ ржХрж░рж╛            | ржбрзЗржЯрж╛ рж╕ржВрж░ржХрзНрж╖ржгрзЗрж░ ржЖржЧрзЗ validation, encryption, slug generate ржЗрждрзНржпрж╛ржжрж┐ ржХрж░рж╛ |
| **Access**         | `this` ржорж╛ржирзЗ рж╣рзЯ **query object**                                       | `this` ржорж╛ржирзЗ рж╣рзЯ **document object**                                   |

---

## ЁЯзк ржЙржжрж╛рж╣рж░ржгрзЗ ржмрзНржпрж╛ржЦрзНржпрж╛

### ЁЯУМ 1. Query Middleware

```js
// тЬЕ Query Middleware: Hide secret tours from any find query
tourSchema.pre(/^find/, function (next) {
  this.find({ secretTour: { $ne: true } }); // Query ржХрзЗ modify ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ
  next();
});
```

ЁЯСЙ ржпржЦржиржЗ `Tour.find()` ржмрж╛ `Tour.findOne()` ржЪрж▓ржмрзЗ, рж╕рзЗржЦрж╛ржирзЗ `secretTour: true` ржлрж┐рж▓рзНржб exclude ржХрж░рж╛ рж╣ржмрзЗред

---

### ЁЯУМ 2. Document Middleware

```js
// тЬЕ Document Middleware: Create slug before saving
tourSchema.pre("save", function (next) {
  this.slug = this.name.toLowerCase().split(" ").join("-");
  next();
});
```

ЁЯСЙ ржпржЦржи ржирждрзБржи ржЯрзНржпрзБрж░ рждрзИрж░рж┐ ржмрж╛ рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рж╛ рж╣ржмрзЗ (e.g. `.save()` ржмрж╛ `.create()`), рждржЦржи `name` ржерзЗржХрзЗ ржПржХржЯрж┐ slug рждрзИрж░рж┐ ржХрж░рзЗ рж╕рзЗржЯрж┐ ржлрж┐рж▓рзНржбрзЗ ржмрж╕рж┐рзЯрзЗ ржжрзЗржмрзЗред

---

## ЁЯТб Real-world Example:

- **Query Middleware**:
  тЖТ ржЖржкржирж┐ ржПржХржЬржи user only public data ржжрзЗржЦрждрзЗ ржкрж╛рж░рзЗржиред рждрж╛ржЗ `.find()`-ржПрж░ ржЖржЧрзЗ middleware ржжрж┐рзЯрзЗ private ржбрзЗржЯрж╛ exclude ржХрж░рзЗржиред

- **Document Middleware**:
  тЖТ User password hash ржХрж░рзЗ save ржХрж░рждрзЗ ржЪрж╛ржи? рждрж╛рж╣рж▓рзЗ `.save()`-ржПрж░ ржЖржЧрзЗ password hash ржХрж░ржмрзЗржиред

---

## ЁЯза Middleware Hook ржЯрж╛ржЗржк:

| Middleware ржЯрж╛ржЗржк     | Hook ржирж╛ржо                                       |
| ------------------- | ---------------------------------------------- |
| Query Middleware    | `pre('find')`, `pre(/^find/)`, `post('find')`  |
| Document Middleware | `pre('save')`, `post('save')`, `pre('remove')` |

---

## ЁЯУМ рж╕рж╣ржЬрзЗ ржоржирзЗ рж░рж╛ржЦрж╛рж░ ржЯрж┐ржкрж╕:

- ЁЯФН **Query Middleware** = ржпржЦржи рждрзБржорж┐ ржбрзЗржЯрж╛ _ржЦрзБржБржЬрзЛ_
  ЁЯСЙ ржХрж╛ржЬ ржХрж░рзЗ `.find()`, `.update()` ржПрж░ ржЖржЧрзЗ
  ЁЯСЙ Modify ржХрж░рзЗ query (e.g. hide secret)

- ЁЯУД **Document Middleware** = ржпржЦржи рждрзБржорж┐ ржбрзЗржЯрж╛ _рждрзИрж░рж┐ ржмрж╛ ржЖржкржбрзЗржЯ_ ржХрж░рзЛ
  ЁЯСЙ ржХрж╛ржЬ ржХрж░рзЗ `.save()`, `.create()` ржПрж░ ржЖржЧрзЗ
  ЁЯСЙ Modify ржХрж░рзЗ ржбржХрзБржорзЗржирзНржЯ (e.g. password hash)

---
